<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Texas COVID-19 Hospital Resource Usage</title>
    <meta name="description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta name="keywords" content="COVID-19, coronavirus, SARS-CoV-2, Texas, DSHS, TSA, D3, D3.js, Cases, Outbreak, Pandemic">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="author" content="Colin Sullender">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@shiruken">
    <meta name="twitter:title" content="Texas COVID-19 Hospital Resource Usage">
    <meta name="twitter:description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta name="twitter:image" content="https://covid-texas.csullender.com/social.png">
    
    <meta property="og:title" content="Texas COVID-19 Hospital Resource Usage">
    <meta property="og:description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta property="og:image" content="https://covid-texas.csullender.com/social.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="628">
    <meta property="og:url" content="https://covid-texas.csullender.com/">
    <meta property="og:type" content="website">

    <meta name="viewport" content="width=1100">

    <style>
        body { 
            font-family: Arial, Helvetica, sans-serif;
        }

        a#badge {
            display: block;
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            padding: 10px 5px 10px 50px;
            color: #000000;
            font-weight: bold;
            text-decoration: none;
            text-align: center;
            border: 1px solid #000000;
            border-radius: 10px;
            background: url(sars-cov-2.png) 10px no-repeat;
            background-size: 40px;
            transition-duration: 250ms;
        }
        
        a#badge:hover {
            color: #FFFFFF;
            background-color: #000000;
        }

        header {
            text-align: center;
        }

        header h1#title {
            margin-bottom: 5px;
        }

        h2#subtitle {
            font-size: 1em;
            color: #999;
            font-weight: normal;
            margin-top: 5px;
            min-height: 22px;
        }

        div#control {
            text-align: center;
            font-size: 1.2em;
            margin-top: 50px;
        }

        select#tsaSelect {
            font-size: 1em;
            padding: 3px;
            width: 320px;
        }

        div.container {
            width: 1100px;
            height: 450px;
            margin: 50px auto 75px auto;
        }

        div.chart {
            float: left;
            width: 880px;
            height: 450px;
        }

        g.xAxis, g.yAxis {
            font-size: 0.9em;
        }

        g.yAxisGrid {
            color: #ccc;
        }

        text.chartTitle {
            font-size: 1.1em;
            font-weight: bold;
        }

        .hover-line {
            stroke: #999999;
            stroke-width: 1px;
            stroke-dasharray: 4,4;
        }

        circle {
            transform: scale(1);            
        }

        circle.pulse {
            transform-origin: center center;
            transform-box: fill-box;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.75);
            }
            100% {
                transform: scale(1);
            }
        }

        .note line {
            stroke: #999999;
            stroke-width: 1px;
            stroke-dasharray: 2,2;
        }

        .note text {
            font-size: 0.8em;
            fill: #999999;
            white-space: pre;
        }

        div.data {
            float: right;
            width: 220px;
            padding-top: 40px;
        }

        div.data h4 {
            margin: 0px 20px;
            font-style: italic;
            font-weight: normal;
        }

        div.data h3 {
            font-size: 1em;
            font-weight: normal;
            margin: 20px 10px 10px 20px;
        }

        div.data h3 strong {
            font-size: 1.5em;
        }

        strong.bed-number {
            color: #7570B3;
        }

        strong.covid-number {
            color: #D95F02;
        }

        div.data dl {
            font-size: 0.9em;
            margin: 60px 10px 10px 20px;
        }

        div#data-bed-count dl {
            margin-top: 10px;
            margin-bottom: 50px;
        }

        div.data dt {
            margin-top: 10px;
        }

        div.data dd {
            font-size: 1.1em;
            font-weight: bold;
            margin: 5px 0px;
        }

        footer {
            text-align: center;
            color: #999;
            clear: both;
        }

        footer a, footer a:visited {
            color: #999;
            text-decoration: none;
        }

        footer a:hover, a:active {
            border-bottom: 1px dotted #999;
        }

        div.alert {
            padding: 15px 30px;
            margin: 20px auto;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: #f2dede;
            border-color: #ebccd1;
            color: #a94442;
        }

    </style>
</head>

<body>

    <a id="badge" href="https://covid.csullender.com/">Check out My COVID-19 Tracker</a>

    <header>
        <h1 id="title">Texas COVID-19 Hospital Resource Usage</h1>
        <h2 id="subtitle"></h2>
        <div class="alert">Today's DSHS data is incomplete "due to a transition in reporting to comply with new federal requirements"</div>
    </header>

    <div id="control">
        <label for="tsa">Select Location:</label>
        <select name="tsa" id="tsaSelect"></select>
    </div>
    <div class="container">
        <div id="chart-hospital-beds" class="chart"></div>
        <div id="data-hospital-beds" class="data"></div>
    </div>
    <div class="container">
        <div id="chart-icu-beds" class="chart"></div>
        <div id="data-icu-beds" class="data"></div>
    </div>
    <div class="container">
        <div id="chart-bed-count" class="chart"></div>
        <div id="data-bed-count" class="data"></div>
    </div>
    <footer>
        <p>
            Data from 
            <a href="https://www.dshs.state.tx.us/coronavirus/additionaldata/" target="_blank">Texas DSHS</a> Â· 
            <a href="https://github.com/shiruken/covid-texas" target="_blank">View on GitHub</a>
        </p>
    </footer>

    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        
        const margin = {top: 30, right: 15, bottom: 30, left: 55},
            width = 880 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        // Define redundant y-axis elements
        var y = d3.scaleLinear()
            .domain([0, 100])
            .range([height, 0]);

        var yAxis = d3.axisLeft(y)
            .ticks(5)
            .tickFormat(d => d + "%");

        var yAxisGrid = d3.axisLeft(y)
            .tickSize(-width)
            .tickFormat('')
            .ticks(5);

        // Total Hospital Bed Usage Chart
        var svg_total = d3.select('#chart-hospital-beds')
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg_total.append('g')
            .attr('class', 'yAxisGrid')
            .call(yAxisGrid);

        svg_total.append("g")
            .attr('class', 'yAxis')
            .call(yAxis);

        var hover_line_total = svg_total.append("line")
            .attr("class", "hover-line")
            .attr("x1", width)
            .attr("x2", width)
            .attr("y1", 0)
            .attr("y2", height)
            .style("opacity", 0);

        var legendScale_total = d3.scaleOrdinal()
            .domain(["Hospital Beds Used", "Used Beds with COVID-19"])
            .range(["#7570B3", "#D95F02"]);

        var legend_total = d3.legendColor()
            .scale(legendScale_total)
            .shapePadding(5);

        var legend_total_container = svg_total.append("g")
            .attr("transform", "translate(20, 20)")
            .call(legend_total);


        // ICU Bed Usage Chart
        var svg_icu = d3.select('#chart-icu-beds')
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg_icu.append('g')
            .attr('class', 'yAxisGrid')
            .call(yAxisGrid);

        svg_icu.append("g")
            .attr('class', 'yAxis')
            .call(yAxis);

        var hover_line_icu = svg_icu.append("line")
            .attr("class", "hover-line")
            .attr("x1", width)
            .attr("x2", width)
            .attr("y1", 0)
            .attr("y2", height)
            .style("opacity", 0);

        var legendScale_icu = d3.scaleOrdinal()
            .domain(["ICU Beds Used", "Used ICU Beds with COVID-19"])
            .range(["#7570B3", "#D95F02"]);

        var legend_icu = d3.legendColor()
            .scale(legendScale_icu)
            .shapePadding(5);

        var legend_icu_container = svg_icu.append("g")
            .attr("id", "legend-icu")
            .call(legend_icu);


        // Bed Count Chart
        var svg_count = d3.select('#chart-bed-count')
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg_count.append('g')
            .attr('class', 'yAxisGrid');

        svg_count.append("g")
            .attr('class', 'yAxis');

        var hover_line_count = svg_count.append("line")
            .attr("class", "hover-line")
            .attr("x1", width)
            .attr("x2", width)
            .attr("y1", 0)
            .attr("y2", height)
            .style("opacity", 0);

        var legendScale_count = d3.scaleOrdinal()
            .domain(["Staffed Hospital Beds", "Total ICU Beds"])
            .range(["#7570B3", "#D95F02"]);

        var legend_count = d3.legendColor()
            .scale(legendScale_count)
            .shapePadding(5);

        var legend_count_container = svg_count.append("g")
            .attr("id", "legend-count")
            .call(legend_count);


        var parseDate = d3.timeParse("%Y-%m-%d");
        var formatDate = d3.timeFormat("%B %e, %Y");
        var bisectDate = d3.bisector(d => d.date).left;


        d3.csv('data.csv', function(d) {

            let total_beds_available = parseValue(d.total_beds_available),
                total_beds_occupied = parseValue(d.total_beds_occupied),
                icu_beds_available = parseValue(d.icu_beds_available),
                icu_beds_occupied = parseValue(d.icu_beds_occupied),
                covid_inpatients = parseValue(d.covid_inpatients),
                covid_icu_inpatients = parseValue(d.covid_icu_inpatients);
                
            return {
                tsa: d.tsa,
                location: d.location,
                date: parseDate(d['date']),
                total_beds_available: total_beds_available,
                total_beds_occupied: total_beds_occupied,
                total_beds: total_beds_occupied + total_beds_available,
                percent_total_occupied: 100 * total_beds_occupied / (total_beds_occupied + total_beds_available),
                icu_beds_available: icu_beds_available,
                icu_beds_occupied: icu_beds_occupied,
                icu_beds: icu_beds_occupied + icu_beds_available,
                percent_icu_occupied: 100 * icu_beds_occupied / (icu_beds_occupied + icu_beds_available),
                covid_inpatients: covid_inpatients,
                covid_icu_inpatients: covid_icu_inpatients,
                percent_total_covid: 100 * covid_inpatients / total_beds_occupied,
                percent_icu_covid: 100 * covid_icu_inpatients / icu_beds_occupied
            };
        }).then(function(data) {

            // Group data by TSA
            var data = d3.nest()
                .key(function(d) { return d.tsa; })
                .object(data);
            var tsaIDs = Object.keys(data);
            tsaIDs.unshift(tsaIDs.pop()); // Statewide Total should be first

            // Check for query string parameter defining the default TSA
            var url = new URL(window.location.href);
            var TSA = url.searchParams.get("tsa");
            if (TSA === null || !tsaIDs.includes(TSA)) {
                TSA = "Total"; // Default to Statewide Total
            }

            // Update subtitle
            let N = data[TSA].length - 1;
            d3.select("#subtitle").text("Trauma Service Area (TSA) data updated on "
                + formatDate(data[TSA][N].date));

            // Populate select menu and select default TSA
            d3.select("#tsaSelect")
                .selectAll('options')
                .data(tsaIDs)
                .enter()
                .append('option')
                .text(function (d) { 
                    if (d === "Total")
                        return data[d][0]['location'];
                    else
                        return data[d][0]['location'] + " (TSA-" + d + ")";               
                })
                .attr("value", function (d) { return d; })
                .property("selected", function(d){ return d === TSA; });

            // Populate details sections
            updateTotalDetails(data[TSA][N]);     
            updateICUDetails(data[TSA][N]);  
            updateCountDetails(data[TSA][N]);   
 
            // Total Hospital Bed Usage Chart
            var xExtent_total = getDateExtent(data[TSA], 'percent_total_occupied');
            var x_total = d3.scaleTime()
                .domain(xExtent_total)
                .range([0, width]);
            
            var xAxis_total = svg_total.append("g")
                .attr('class', 'xAxis')
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x_total));

            var note_total = svg_total.append('g')
                .attr("class", "note")
                .style("opacity", TSA === "Total" ? 1 : 0);

            note_total.append("line")
                .attr("x1", x_total(parseDate('2020-05-29')))
                .attr("x2", x_total(parseDate('2020-05-29')))
                .attr("y1", y(15))
                .attr("y2", height);

            note_total.append("text")
                .text('Data incomplete prior to May 29 ')
                .attr("x", x_total(parseDate('2020-05-29')))             
                .attr("y", y(13))
                .attr("text-anchor", "end");

            var plot_usage_total = svg_total.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#7570B3")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_total(d.date); })
                    .y(function(d) { return y(d.percent_total_occupied); })
                    .defined(function(d) { return !isNaN(d.percent_total_occupied); })
                );

            var plot_covid_total = svg_total.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#D95F02")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_total(d.date); })
                    .y(function(d) {return y(d.percent_total_covid); })
                    .defined(function(d) { return !isNaN(d.percent_total_covid); })
                );

            var title_total = svg_total.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .attr('class', 'chartTitle');
            if (TSA === "Total")
                title_total.text("Statewide Hospital Bed Usage");
            else
                title_total.text("Hospital Bed Usage in " + data[TSA][0].location + " (TSA-" + data[TSA][0].tsa + ")");

            var focus_circle_usage_total = svg_total.append("circle")
                .attr("r", 6)
                .attr("fill", "#7570B3")
                .classed("pulse", true)
                .attr("cx", x_total(data[TSA][N].date))
                .attr("cy", y(data[TSA][N].percent_total_occupied));

            var focus_circle_covid_total = svg_total.append("circle")
                .attr("r", 6)
                .attr("fill", "#D95F02")
                .classed("pulse", true)
                .attr("cx", x_total(data[TSA][N].date))
                .attr("cy", y(data[TSA][N].percent_total_covid));

            var overlay_total = svg_total.append('rect')
                .datum(data[TSA])
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('width', width)
                .attr('height', height)
                .on("mouseover", function() { 
                    hover_line_total.style("opacity", 1);
                    focus_circle_usage_total.classed("pulse", false);
                    focus_circle_covid_total.classed("pulse", false);
                })
                .on("mouseout", function(d) {
                    hover_line_total.style("opacity", 0);
                    let N = d.length - 1;
                    focus_circle_usage_total
                        .attr("cx", x_total(d[N].date))
                        .attr("cy", y(d[N].percent_total_occupied))
                        .classed("pulse", true);
                    focus_circle_covid_total
                        .attr("cx", x_total(d[N].date))
                        .attr("cy", y(d[N].percent_total_covid))
                        .classed("pulse", true);
                    updateTotalDetails(d[N]);
                })
                .on('mousemove', function(d) { 
                    var x0 = x_total.invert(d3.mouse(this)[0]);
                    var i = bisectDate(d, x0, 0, d.length - 1);

                    if (!isNaN(d[i].percent_total_occupied)) {
                        hover_line_total
                            .attr("x1", x_total(d[i].date))
                            .attr("x2", x_total(d[i].date));
                        focus_circle_usage_total
                            .attr("cx", x_total(d[i].date))
                            .attr("cy", y(d[i].percent_total_occupied));
                        focus_circle_covid_total
                            .attr("cx", x_total(d[i].date))
                            .attr("cy", y(d[i].percent_total_covid));
                        updateTotalDetails(d[i]);
                    }
                 });


            // ICU Bed Usage Chart
            var xExtent_icu = getDateExtent(data[TSA], 'percent_icu_occupied');
            var x_icu = d3.scaleTime()
                .domain(xExtent_icu)
                .range([0, width]);
            
            var xAxis_icu = svg_icu.append("g")
                .attr('class', 'xAxis')
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x_icu));

            var note_icu = svg_icu.append('g')
                .attr("class", "note")
                .style("opacity", TSA === "Total" ? 1 : 0);

            note_icu.append("line")
                .attr("x1", x_icu(parseDate('2020-05-29')))
                .attr("x2", x_icu(parseDate('2020-05-29')))
                .attr("y1", y(30))
                .attr("y2", height);

            note_icu.append("text")
                .text('Data incomplete prior to May 29 ')
                .attr("x", x_icu(parseDate('2020-05-29')))             
                .attr("y", y(28))
                .attr("text-anchor", "end");

            var plot_usage_icu = svg_icu.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#7570B3")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_icu(d.date); })
                    .y(function(d) { return y(d.percent_icu_occupied); })
                    .defined(function(d) { return !isNaN(d.percent_icu_occupied); })
                );

            var plot_covid_icu = svg_icu.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#D95F02")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_icu(d.date); })
                    .y(function(d) {return y(d.percent_icu_covid); })
                    .defined(function(d) {return !isNaN(d.percent_icu_covid); })
                );

            moveICULegend(TSA, 0);

            var title_icu = svg_icu.append("text")
                .attr("x", (width / 2))             
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")  
                .attr('class', 'chartTitle');
            if (TSA === "Total")
                title_icu.text("Statewide ICU Bed Usage");
            else
                title_icu.text("ICU Bed Usage in " + data[TSA][0].location + " (TSA-" + data[TSA][0].tsa + ")");

            var focus_circle_usage_icu = svg_icu.append("circle")
                .attr("r", 6)
                .attr("fill", "#7570B3")
                .classed("pulse", true)
                .attr("cx", x_icu(data[TSA][N].date))
                .attr("cy", y(data[TSA][N].percent_icu_occupied));

            var focus_circle_covid_icu = svg_icu.append("circle")
                .attr("r", 6)
                .attr("fill", "#D95F02")
                .classed("pulse", true)
                .attr("cx", x_icu(data[TSA][N].date))
                .attr("cy", y(data[TSA][N].percent_icu_covid));

            var overlay_icu = svg_icu.append('rect')
                .datum(data[TSA])
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('width', width)
                .attr('height', height)
                .on("mouseover", function() { 
                    hover_line_icu.style("opacity", 1);
                    focus_circle_usage_icu.classed("pulse", false);
                    focus_circle_covid_icu.classed("pulse", false);
                })
                .on("mouseout", function(d) {
                    hover_line_icu.style("opacity", 0);
                    let N = d.length - 1;
                    focus_circle_usage_icu
                        .attr("cx", x_icu(d[N].date))
                        .attr("cy", y(d[N].percent_icu_occupied))
                        .classed("pulse", true);
                    focus_circle_covid_icu
                        .attr("cx", x_icu(d[N].date))
                        .attr("cy", y(d[N].percent_icu_covid))
                        .classed("pulse", true);
                    updateICUDetails(d[N]);
                })
                .on('mousemove', function(d) { 
                    var offset = bisectDate(d, xExtent_icu[0]) + 1;
                    var x0 = x_icu.invert(d3.mouse(this)[0]);
                    var i = bisectDate(d, x0, offset, d.length - 1);

                    if (!isNaN(d[i].percent_icu_covid)) {
                        focus_circle_usage_icu
                            .attr("cx", x_icu(d[i].date))
                            .attr("cy", y(d[i].percent_icu_occupied));
                        focus_circle_covid_icu
                            .attr("cx", x_icu(d[i].date))
                            .attr("cy", y(d[i].percent_icu_covid));
                        hover_line_icu
                            .attr("x1", x_icu(d[i].date))
                            .attr("x2", x_icu(d[i].date));
                        updateICUDetails(d[i]);
                    }
                });


            // Bed Count Chart            
            var xAxis_count = svg_count.append("g")
                .attr('class', 'xAxis')
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x_total));

            var yMax_count = d3.max(data[TSA], function(d) {return d.total_beds;} );
            var y_count = d3.scaleLinear()
                .domain([0, yMax_count]).nice(4)
                .range([height, 0]);

            var yAxis_format_count = d3.axisLeft(y_count)
                .ticks(4);

            var yAxisGrid_format_count = d3.axisLeft(y_count)
                .tickSize(-width)
                .tickFormat('')
                .ticks(4);

            var yAxiGrid_count = svg_count.append('g')
                .attr('class', 'yAxisGrid')
                .call(yAxisGrid_format_count);

            var yAxis_count = svg_count.append("g")
                .attr('class', 'yAxis')
                .call(yAxis_format_count);

            var note_count = svg_count.append('g')
                .attr("class", "note")
                .style("opacity", TSA === "Total" ? 1 : 0);

            note_count.append("line")
                .attr("x1", x_total(parseDate('2020-05-29')))
                .attr("x2", x_total(parseDate('2020-05-29')))
                .attr("y1", y_count(15000))
                .attr("y2", height);

            note_count.append("text")
                .text('Data incomplete prior to May 29 ')
                .attr("x", x_total(parseDate('2020-05-29')))             
                .attr("y", y_count(14000))
                .attr("text-anchor", "end");

            var plot_bed_count = svg_count.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#7570B3")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_total(d.date); })
                    .y(function(d) { return y_count(d.total_beds); })
                    .defined(function(d) { return !isNaN(d.total_beds); })
                );

            var plot_icu_count = svg_count.append("path")
                .datum(data[TSA])
                .attr("fill", "none")
                .attr("stroke", "#D95F02")
                .attr("stroke-width", 4)
                .attr("d", d3.line()
                    .x(function(d) { return x_total(d.date); })
                    .y(function(d) {return y_count(d.icu_beds); })
                    .defined(function(d) { return !isNaN(d.icu_beds); })
                );

            moveCountLegend(TSA, 0);

            var title_count = svg_count.append("text")
                    .attr("x", (width / 2))             
                    .attr("y", 0 - (margin.top / 2))
                    .attr("text-anchor", "middle")  
                    .attr('class', 'chartTitle')
            if (TSA === "Total")
                title_count.text("Statewide Total Hospital Resources");
            else
                title_count.text("Total Hospital Resources in " + data[TSA][0].location + " (TSA-" + data[TSA][0].tsa + ")");
                
            var focus_circle_bed_count = svg_count.append("circle")
                .attr("r", 6)
                .attr("fill", "#7570B3")
                .classed("pulse", true)
                .attr("cx", x_total(data[TSA][N].date))
                .attr("cy", y_count(data[TSA][N].total_beds));

            var focus_circle_icu_count = svg_count.append("circle")
                .attr("r", 6)
                .attr("fill", "#D95F02")
                .classed("pulse", true)
                .attr("cx", x_total(data[TSA][N].date))
                .attr("cy", y_count(data[TSA][N].icu_beds));

            var overlay_count = svg_count.append('rect')
                .datum(data[TSA])
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('width', width)
                .attr('height', height)
                .on("mouseover", function() { 
                    hover_line_count.style("opacity", 1);
                    focus_circle_bed_count.classed("pulse", false);
                    focus_circle_icu_count.classed("pulse", false);
                })
                .on("mouseout", function(d) {
                    hover_line_count.style("opacity", 0);
                    let N = d.length - 1;
                    focus_circle_bed_count
                        .attr("cx", x_total(d[N].date))
                        .attr("cy", y_count(d[N].total_beds))
                        .style("opacity", 1)
                        .classed("pulse", true);
                    focus_circle_icu_count
                        .attr("cx", x_total(d[N].date))
                        .attr("cy", y_count(d[N].icu_beds))
                        .style("opacity", 1)
                        .classed("pulse", true);
                    updateCountDetails(d[N]);
                })
                .on('mousemove', function(d) { 
                    var x0 = x_total.invert(d3.mouse(this)[0]);
                    var i = bisectDate(d, x0, 0, d.length - 1);

                    if (!isNaN(d[i].total_beds))
                        focus_circle_bed_count
                            .style("opacity", 1)
                            .attr("cx", x_total(d[i].date))
                            .attr("cy", y_count(d[i].total_beds));
                    else
                        focus_circle_bed_count.style("opacity", 0);

                    if (!isNaN(d[i].icu_beds))
                        focus_circle_icu_count
                            .style("opacity", 1)
                            .attr("cx", x_total(d[i].date))
                            .attr("cy", y_count(d[i].icu_beds));
                    else
                        focus_circle_icu_count.style("opacity", 0);

                    if (!isNaN(d[i].total_beds) || !isNaN(d[i].icu_beds)) {
                        hover_line_count
                            .attr("x1", x_total(d[i].date))
                            .attr("x2", x_total(d[i].date));
                        updateCountDetails(d[i]);
                    }
                });


            // Update charts when different TSA is selected
            d3.select("#tsaSelect").on("change", function(d) {
                var TSA = d3.select(this).property("value");

                if (TSA === "Total")
                    window.history.replaceState(null, null, window.location.pathname);
                else
                    window.history.replaceState(null, null, "?tsa=" + TSA);

                // Update x-axis ranges
                xExtent_total = getDateExtent(data[TSA], 'percent_total_occupied'); 
                x_total.domain(xExtent_total);
                xAxis_total
                    .transition()
                    .duration(250)
                    .call(d3.axisBottom(x_total));

                xExtent_icu = getDateExtent(data[TSA], 'percent_icu_occupied');
                x_icu.domain(xExtent_icu);
                xAxis_icu
                    .transition()
                    .duration(250)
                    .call(d3.axisBottom(x_icu));

                xAxis_count
                    .transition()
                    .duration(250)
                    .call(d3.axisBottom(x_total));

                // Update y-axis ranges
                yMax_count = d3.max(data[TSA], function(d) {return d.total_beds;} );
                y_count.domain([0, yMax_count]).nice(4);
                yAxis_format_count = d3.axisLeft(y_count)
                    .ticks(4);
                yAxisGrid_format_count = d3.axisLeft(y_count)
                    .tickSize(-width)
                    .tickFormat('')
                    .ticks(4);
                yAxiGrid_count.call(yAxisGrid_format_count);
                yAxis_count.call(yAxis_format_count);

                // Draw new total hospital bed usage line
                plot_usage_total.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_total(d.date); })
                        .y(function(d) { return y(d.percent_total_occupied); })
                        .defined(function(d) { return !isNaN(d.percent_total_occupied); })
                    );

                // Draw new total hospital bed COVID-19 usage line
                plot_covid_total.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_total(d.date); })
                        .y(function(d) {return y(d.percent_total_covid); })
                        .defined(function(d) { return !isNaN(d.percent_total_covid); })
                    );

                // Draw new ICU bed usage line
                plot_usage_icu.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_icu(d.date); })
                        .y(function(d) { return y(d.percent_icu_occupied); })
                        .defined(function(d) { return !isNaN(d.percent_icu_occupied); })
                    );

                // Draw new ICU bed COVID-19 usage line
                plot_covid_icu.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_icu(d.date); })
                        .y(function(d) {return y(d.percent_icu_covid); })
                        .defined(function(d) { return !isNaN(d.percent_icu_covid); })
                    );

                // Draw new total bed count line
                plot_bed_count.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_total(d.date); })
                        .y(function(d) { return y_count(d.total_beds); })
                        .defined(function(d) { return !isNaN(d.total_beds); })
                    );

                // Draw new ICU bed count line
                plot_icu_count.datum(data[TSA])
                    .transition()
                    .duration(250)
                    .attr("d", d3.line()
                        .x(function(d) { return x_total(d.date); })
                        .y(function(d) { return y_count(d.icu_beds); })
                        .defined(function(d) { return !isNaN(d.icu_beds); })
                    );

                // Update titles
                let tsa = data[TSA][0].tsa;
                let location = data[TSA][0].location;
                if (TSA === "Total") {
                    title_total.text("Statewide Hospital Bed Usage");
                    title_icu.text("Statewide ICU Bed Usage");
                    title_count.text("Statewide Total Hospital Resources");
                } else {
                    title_total.text("Hospital Bed Usage in " + location + " (TSA-" + tsa + ")");
                    title_icu.text("ICU Bed Usage in " + location + " (TSA-" + tsa + ")");
                    title_count.text("Total Hospital Resources in " + location + " (TSA-" + tsa + ")");
                }

                // Toggle 'Statewide Total' notes
                if (TSA === "Total") {
                    note_total.transition().duration(250).style('opacity', 1);
                    note_icu.transition().duration(250).style('opacity', 1);
                    note_icu.select("line")
                        .attr("x1", x_icu(parseDate('2020-05-29')))
                        .attr("x2", x_icu(parseDate('2020-05-29')));
                    note_icu.select("text")
                        .attr("x", x_icu(parseDate('2020-05-29')))             
                    note_count.transition().duration(250).style('opacity', 1);
                    note_count.select("line").attr("y1", y_count(15000));
                    note_count.select("text").attr("y", y_count(14000));
                } else {
                    note_total.style('opacity', 0);
                    note_icu.style('opacity', 0);
                    note_count.style('opacity', 0);
                }

                // Update mouseover overlay data
                overlay_total.datum(data[TSA]);
                overlay_icu.datum(data[TSA]);
                overlay_count.datum(data[TSA]);

                // Update details sections
                let N = data[TSA].length - 1;
                updateTotalDetails(data[TSA][N]);
                updateICUDetails(data[TSA][N]);
                updateCountDetails(data[TSA][N]);

                // Move focus circles to new coordinates
                focus_circle_usage_total
                    .transition()
                    .duration(250)
                    .attr("cx", x_total(data[TSA][N].date))
                    .attr("cy", y(data[TSA][N].percent_total_occupied));

                focus_circle_covid_total
                    .transition()
                    .duration(250)
                    .attr("cx", x_total(data[TSA][N].date))
                    .attr("cy", y(data[TSA][N].percent_total_covid));

                focus_circle_usage_icu
                    .transition()
                    .duration(250)
                    .attr("cx", x_icu(data[TSA][N].date))
                    .attr("cy", y(data[TSA][N].percent_icu_occupied));

                focus_circle_covid_icu
                    .transition()
                    .duration(250)
                    .attr("cx", x_icu(data[TSA][N].date))
                    .attr("cy", y(data[TSA][N].percent_icu_covid));

                focus_circle_bed_count
                    .transition()
                    .duration(250)
                    .attr("cx", x_total(data[TSA][N].date))
                    .attr("cy", y_count(data[TSA][N].total_beds));

                focus_circle_icu_count
                    .transition()
                    .duration(250)
                    .attr("cx", x_total(data[TSA][N].date))
                    .attr("cy", y_count(data[TSA][N].icu_beds));

                // Reposition legends based on selected TSA
                moveICULegend(TSA, 250);
                moveCountLegend(TSA, 250);

            });

        });

        // Missing values are parsed as NaN
        function parseValue(value) {
            if (value === "")
                return NaN;
            else
                return +value;
        }

        // Return padded date extent for given key
        function getDateExtent(data, key) {
            let max = d3.max(data, function(d) { return d.date; });
            let min = d3.min(data, function(d) {
                if (isNaN(d[key]))
                    return max;
                else
                    return d.date;
            });
            return [d3.timeDay.offset(min, -1), d3.timeDay.offset(max, 1)]
        }
        
        // Update Total Hospital Bed details
        function updateTotalDetails(data) {
            var options = {minimumFractionDigits: 0, maximumFractionDigits: 0};
            d3.select("#data-hospital-beds").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + 
                    data.percent_total_occupied.toLocaleString(undefined, options) + 
                    "%</strong> of beds used" + 
                "</h3>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + 
                    data.percent_total_covid.toLocaleString(undefined, options) + 
                    "%</strong> of used beds have COVID-19 patients" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Staffed Hospital Beds</dt>" +
                    "<dd>" + (data.total_beds_available + data.total_beds_occupied).toLocaleString() + "</dd>" +
                    "<dt>Occupied Hospital Beds</dt>" +
                    "<dd>" + data.total_beds_occupied.toLocaleString() + "</dd>" +
                    "<dt>Available Hospital Beds</dt>" +
                    "<dd>" + data.total_beds_available.toLocaleString() + "</dd>" +
                    "<dt>COVID-19 Patients</dt>" +
                    "<dd>" + data.covid_inpatients.toLocaleString() + "</dd>" +
                "</dl>"
            );
        }

        // Update ICU Bed details
        function updateICUDetails(data) {
            var options = {minimumFractionDigits: 0, maximumFractionDigits: 0};
            d3.select("#data-icu-beds").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + 
                    data.percent_icu_occupied.toLocaleString(undefined, options) + 
                    "%</strong> of ICU beds used" + 
                "</h3>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + 
                    data.percent_icu_covid.toLocaleString(undefined, options) + 
                    "%</strong> of used ICU beds have COVID-19 patients" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Total ICU Beds</dt>" +
                    "<dd>" + (data.icu_beds_available + data.icu_beds_occupied).toLocaleString() + "</dd>" +
                    "<dt>Occupied ICU Beds</dt>" +
                    "<dd>" + data.icu_beds_occupied.toLocaleString() + "</dd>" +
                    "<dt>Available ICU Beds</dt>" +
                    "<dd>" + data.icu_beds_available.toLocaleString() + "</dd>" +
                    "<dt>COVID-19 ICU Patients</dt>" +
                    "<dd>" + data.covid_icu_inpatients.toLocaleString() + "</dd>" +
                "</dl>"
            );
        }

        // Update Bed Count details
        function updateCountDetails(data) {
            var options = {minimumFractionDigits: 0, maximumFractionDigits: 0};
            d3.select("#data-bed-count").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + 
                    (isNaN(data.total_beds) ? 'NA' : data.total_beds.toLocaleString(undefined, options)) + 
                    "</strong> staffed beds" + 
                "</h3>" +
                "<dl>" +
                    "<dt>Occupied</dt>" +
                    "<dd>" + (isNaN(data.total_beds_occupied) ? 'NA' : data.total_beds_occupied.toLocaleString()) + "</dd>" +
                    "<dt>Available</dt>" +
                    "<dd>" + data.total_beds_available.toLocaleString() + "</dd>" +
                "</dl>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + 
                    (isNaN(data.icu_beds_occupied) ? 'NA' : data.icu_beds.toLocaleString(undefined, options)) + 
                    "</strong> total ICU beds" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Occupied</dt>" +
                    "<dd>" + (isNaN(data.icu_beds_occupied) ? 'NA' : data.icu_beds_occupied.toLocaleString()) + "</dd>" +
                    "<dt>Available</dt>" +
                    "<dd>" + data.icu_beds_available.toLocaleString() + "</dd>" +
                "</dl>"
            );
        }

        // Position ICU chart legend based on currently selected TSA
        function moveICULegend(TSA,duration) {
            let tform;

            switch(TSA) {
                case "H":
                    tform = "translate(20, 175)";
                    break;
                case "I":
                    tform = "translate(20, 175)";
                    break;
                case "M":
                    tform = "translate(20, 255)";
                    break;
                case "Q":
                    tform = "translate(20, 175)";
                    break;
                case "R":
                    tform = "translate(20, 100)";
                    break;
                case "T":
                    tform = "translate(20, 175)";
                    break;
                case "U":
                    tform = "translate(20, 100)";
                    break;
                default:
                    tform = "translate(20, 20)";
            }

            d3.select("g#legend-icu")
                .transition()
                .duration(duration)
                .attr("transform", tform);
        }

        // Position count chart legend based on currently selected TSA
        function moveCountLegend(TSA,duration) {
            let tform;

            switch(TSA) {
                case "A":
                    tform = "translate(20, 280)";
                    break;
                case "C":
                    tform = "translate(20, 20)";
                    break;
                case "D":
                    tform = "translate(20, 15)";
                    break;
                case "E":
                    tform = "translate(20, 30)";
                    break;
                case "G":
                    tform = "translate(20, 20)";
                    break;
                case "I":
                    tform = "translate(20, 225)";
                    break;
                case "M":
                    tform = "translate(20, 225)";
                    break;
                case "O":
                    tform = "translate(20, 225)";
                    break;
                case "P":
                    tform = "translate(20, 30)";
                    break;
                case "R":
                    tform = "translate(20, 225)";
                    break;
                case "S":
                    tform = "translate(20, 30)";
                    break;
                case "U":
                    tform = "translate(20, 30)";
                    break;
                case "V":
                    tform = "translate(20, 30)";
                    break;
                default:
                    tform = "translate(20, 175)";
            }

            d3.select("g#legend-count")
                .transition()
                .duration(duration)
                .attr("transform", tform);
        }

    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-26412009-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-26412009-1');
    </script>

</body>
</html>